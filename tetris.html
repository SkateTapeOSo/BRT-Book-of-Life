<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Block Stacker</title>
<style>
  :root{--bg1:#0f2027;--bg2:#203a43;--bg3:#2c5364}
  html,body{height:100%;margin:0;overflow:hidden}
  body{display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,var(--bg1),var(--bg2),var(--bg3));background-size:400% 400%;animation:bg 12s ease infinite;font-family:system-ui,-apple-system,Segoe UI,Roboto;color:#fff}
  @keyframes bg{0%{background-position:0 50%}50%{background-position:100% 50%}100%{background-position:0 50%}}
  .wrap{display:grid;grid-template-columns:auto 260px;gap:16px;align-items:start}
  .panel{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:12px}
  #game{box-shadow:0 0 20px rgba(0,255,255,.8),0 0 40px rgba(0,255,255,.45);border-radius:12px;border:2px solid rgba(255,255,255,.4);background:#11141b;outline:none}
  h1{position:fixed;top:10px;left:50%;transform:translateX(-50%);font-size:22px;text-shadow:0 0 10px #0ff,0 0 16px #09f;margin:0}
  ul{list-style:none;margin:0;padding:0}
  li{padding:6px 8px;border-bottom:1px solid rgba(255,255,255,.08)}
  .hint{opacity:.75;font-size:12px;margin-top:6px}
  .btn{cursor:pointer;border:0;border-radius:12px;padding:10px 16px;font-weight:700;color:#00131a;background:linear-gradient(180deg,#00f0f0,#09f);box-shadow:0 0 14px rgba(0,255,255,.5);margin-right:6px}
  .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.45);backdrop-filter:blur(6px)}
  .card{background:rgba(15,18,32,.95);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:20px;box-shadow:0 10px 40px rgba(0,0,0,.5);text-align:center}
  .shake{animation:shake .25s linear both}
  @keyframes shake{0%{transform:translate(2px,0)}25%{transform:translate(-2px,0)}50%{transform:translate(2px,0)}75%{transform:translate(-2px,0)}100%{transform:translate(0,0)}}
  .pulse{animation:pulse 0.6s ease-out}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(0,255,255,.9)}100%{box-shadow:0 0 0 24px rgba(0,255,255,0)}}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .label{opacity:.9}
  input.initials{width:70px;text-transform:uppercase;text-align:center;font-size:18px;border-radius:10px;border:1px solid #39c;background:#0b0f18;color:#fff;padding:8px}
</style>
</head>
<body>
  <h1>Play Tetris</h1>
  <div class="wrap">
    <canvas id="game" width="300" height="600" aria-label="Tetris Game" tabindex="0"></canvas>
    <div class="panel">
      <div class="panel"><strong>Score:</strong> <span id="score">0</span> &nbsp; <span class="label">Level:</span> <span id="level">0</span></div>

      <div class="panel" style="margin-top:8px">
        <div class="row">
          <div class="panel">
            <strong>Next</strong><br/>
            <canvas id="next" width="96" height="96"></canvas>
          </div>
          <div class="panel">
            <strong>Hold</strong><br/>
            <canvas id="hold" width="96" height="96"></canvas><br/>
            <span class="hint">Press H to hold</span>
          </div>
        </div>
      </div>

      <div class="panel" style="margin-top:8px">
        <strong>Scoreboard (Top 10)</strong>
        <ul id="board"></ul>
      </div>

      <div class="panel" style="margin-top:8px">
        <strong>Controls</strong>
        <div class="hint">← → move · ↑ rotate · ↓ soft drop · <b>Enter</b> hard drop · <b>H</b> hold · <b>P</b> pause</div>
        <div class="row" style="margin-top:8px">
          <button id="pauseBtn" class="btn">Pause</button>
          <button id="restart" class="btn">Restart</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Start Overlay -->
  <div id="startOverlay" class="overlay">
    <div class="card">
      <h2 style="margin-top:0">Ready?</h2>
      <p class="hint">Press the button to begin. Use Arrow Keys to play.</p>
      <button id="startBtn" class="btn">Start Game</button>
    </div>
  </div>

  <!-- Game Over / Initials Overlay -->
  <div id="initialsOverlay" class="overlay" style="display:none">
    <div class="card">
      <h2 style="margin-top:0">Game Over</h2>
      <p class="hint">Enter your initials (3 letters):</p>
      <input id="initialsInput" class="initials" maxlength="3" placeholder="AAA" />
      <div style="margin-top:10px">
        <button id="submitInitials" class="btn">Submit</button>
      </div>
    </div>
  </div>

  <script>
  // ===== WebAudio SFX (no external files) =====
  let AC, master;
  function ensureAudio(){
    if(AC) return;
    AC = new (window.AudioContext||window.webkitAudioContext)();
    master = AC.createGain(); master.gain.value = 0.12; master.connect(AC.destination);
  }
  function tone(freq=440, dur=0.12, type='sine', gain=0.8){
    const o = AC.createOscillator();
    const g = AC.createGain();
    o.type = type; o.frequency.value = freq;
    g.gain.setValueAtTime(0, AC.currentTime);
    g.gain.linearRampToValueAtTime(gain, AC.currentTime + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, AC.currentTime + dur);
    o.connect(g); g.connect(master); o.start(); o.stop(AC.currentTime + dur + 0.02);
  }
  function chord(freqs=[440,554,659], dur=0.18, type='triangle', gain=0.5){ freqs.forEach((f,i)=>tone(f, dur*(1- i*0.05), type, gain)); }
  const SFX = {
    click: ()=>{ensureAudio(); tone(660,0.07,'square',0.25)},
    move:  ()=>{ensureAudio(); tone(220,0.045,'square',0.18)},
    rotate:()=>{ensureAudio(); tone(400,0.07,'triangle',0.22)},
    drop:  ()=>{ensureAudio(); tone(120,0.12,'sawtooth',0.28)},
    lock:  ()=>{ensureAudio(); chord([196,246,294],0.12,'triangle',0.28)},
    clear1:()=>{ensureAudio(); chord([523,659],0.16,'triangle',0.36)},
    clear2:()=>{ensureAudio(); chord([523,659,784],0.18,'triangle',0.38)},
    clear3:()=>{ensureAudio(); chord([523,659,784,988],0.22,'triangle',0.4)},
    clear4:()=>{ensureAudio(); chord([392,523,659,784],0.28,'sine',0.45)},
    level: ()=>{ensureAudio(); chord([587,740,932],0.22,'triangle',0.4)},
    gameOver:()=>{ensureAudio(); [440,392,330,262].forEach((f,i)=>setTimeout(()=>tone(f,0.25,'sine',0.35), i*120))},
  };
  function vibrate(pattern){ if(navigator.vibrate) try{ navigator.vibrate(pattern); }catch(_){} }
  function screenShake(el, ms=180){ el.classList.remove('shake'); void el.offsetWidth; el.classList.add('shake'); setTimeout(()=>el.classList.remove('shake'), ms); }
  function pulse(el){ el.classList.remove('pulse'); void el.offsetWidth; el.classList.add('pulse'); }
  </script>

  <script>
  (function(){
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score');
    const levelEl = document.getElementById('level');
    const boardEl = document.getElementById('board');
    const startOverlay = document.getElementById('startOverlay');
    const startBtn = document.getElementById('startBtn');
    const restartBtn = document.getElementById('restart');
    const pauseBtn = document.getElementById('pauseBtn');
    const initialsOverlay = document.getElementById('initialsOverlay');
    const initialsInput = document.getElementById('initialsInput');
    const submitInitials = document.getElementById('submitInitials');
    const nextCanvas = document.getElementById('next');
    const holdCanvas = document.getElementById('hold');
    const nctx = nextCanvas.getContext('2d');
    const hctx = holdCanvas.getContext('2d');

    const COLS=10, ROWS=20, BLOCK=30;
    const SMALL=24; // block size for next/hold previews
    const COLORS=[null,'#00f0f0','#0000f0','#f0a000','#f0f000','#00f000','#a000f0','#f00000'];
    const TYPES='TJLOSZI';
    const SHAPES={
      'T': [[0,6,0],[6,6,6]],        // using 6 for consistent color index? We'll map properly below
      'J': [[2,0,0],[2,2,2]],
      'L': [[0,0,3],[3,3,3]],
      'O': [[4,4],[4,4]],
      'S': [[0,5,5],[5,5,0]],
      'Z': [[7,7,0],[0,7,7]],
      'I': [[1,1,1,1]]
    };
    // fix color codes to match COLORS index: 1 I,2 J,3 L,4 O,5 S,6 T,7 Z

    let arena, player, dropCounter, dropInterval=900, lastTime, score, running=false, paused=false;
    let lines=0, level=0, canHold=true, holdType=null, nextType=null;

    function createMatrix(w,h){return Array.from({length:h},()=>Array(w).fill(0))}
    function drawMatrix(m, o, bsize=BLOCK, targetCtx=ctx){m.forEach((row,y)=>row.forEach((v,x)=>{if(v){targetCtx.fillStyle=COLORS[v];targetCtx.shadowColor=COLORS[v];targetCtx.shadowBlur=10;targetCtx.fillRect((x+o.x)*bsize,(y+o.y)*bsize,bsize,bsize);targetCtx.shadowBlur=0;}}))}
    function collide(ar,p){const m=p.matrix,o=p.pos;return m.some((row,y)=>row.some((v,x)=>v&&(ar[y+o.y]&&ar[y+o.y][x+o.x])!==0))}
    function merge(ar,p){p.matrix.forEach((row,y)=>row.forEach((v,x)=>{if(v)ar[y+p.pos.y][x+p.pos.x]=v}))}

    function rotateCW(m){
      const h = m.length, w = m[0].length;
      const res = Array.from({length:w},()=>Array(h).fill(0));
      for(let y=0;y<h;y++) for(let x=0;x<w;x++) res[x][h-1-y] = m[y][x];
      return res;
    }
    function rotateCCW(m){
      const h = m.length, w = m[0].length;
      const res = Array.from({length:w},()=>Array(h).fill(0));
      for(let y=0;y<h;y++) for(let x=0;x<w;x++) res[w-1-x][y] = m[y][x];
      return res;
    }

    function randomType(){ return TYPES[(Math.random()*TYPES.length)|0]; }
    function shapeFor(type){
      const base = SHAPES[type].map(r=>r.slice());
      // remap numbers to correct color index per type
      const idx = {'I':1,'J':2,'L':3,'O':4,'S':5,'T':6,'Z':7}[type];
      return base.map(row=>row.map(v=>v?idx:0));
    }

    function spawn(type){
      player.matrix = shapeFor(type);
      player.pos.y = 0;
      player.pos.x = (COLS/2 | 0) - (player.matrix[0].length/2 | 0);
      if (collide(arena, player)) gameOver();
    }

    function hardDrop(){
      do { player.pos.y++; } while(!collide(arena,player));
      player.pos.y--;
      lockPiece();
    }

    function lockPiece(){
      merge(arena,player);
      score+=10; SFX.lock(); updateHUD();
      const cleared=clearLines();
      if(cleared>0){
        lines+=cleared;
        if(lines/10>level){ level=Math.floor(lines/10); dropInterval=Math.max(90, 900 - level*70); SFX.level(); pulse(canvas); }
        [SFX.clear1,SFX.clear2,SFX.clear3,SFX.clear4][cleared-1]?.();
        vibrate(60); screenShake(canvas, 200);
      }
      canHold=true;
      // bring in next piece
      const t = nextType ?? randomType();
      nextType = randomType();
      spawn(t);
      drawNext();
    }

    function drop(){ player.pos.y++; if(collide(arena,player)){ player.pos.y--; lockPiece(); } else { SFX.drop(); } dropCounter=0 }
    function move(d){ player.pos.x+=d; if(collide(arena,player)) player.pos.x-=d; else SFX.move() }
    function spin(dir=1){
      const m = dir>0 ? rotateCW(player.matrix) : rotateCCW(player.matrix);
      const pos = player.pos.x;
      let off = 1;
      while (collide(arena, { pos: player.pos, matrix: m })) {
        player.pos.x += off;
        off = -(off + (off > 0 ? 1 : -1));
        if (off > m[0].length) { player.pos.x = pos; return; }
      }
      player.matrix = m; SFX.rotate();
    }
    function hold(){
      if(!canHold) return;
      canHold=false;
      const currentType = currentPieceType();
      if(holdType==null){
        holdType = currentType;
        // spawn from next
        const t = nextType ?? randomType();
        nextType = randomType();
        spawn(t);
      } else {
        const swap = holdType;
        holdType = currentType;
        spawn(swap);
      }
      drawHold();
    }
    function currentPieceType(){
      // infer from color index of first non-zero cell
      const idx = (player.matrix.flat().find(v=>v) || 1);
      return {1:'I',2:'J',3:'L',4:'O',5:'S',6:'T',7:'Z'}[idx];
    }

    function clearLines(){let cleared=0;outer: for(let y=arena.length-1;y>=0;y--){for(let x=0;x<arena[y].length;x++){if(!arena[y][x])continue outer}const row=arena.splice(y,1)[0].fill(0);arena.unshift(row);cleared++;y++}if(cleared){score+=[0,100,300,500,800][cleared]||0;updateHUD()}return cleared}

    function draw(){
      const g=ctx.createLinearGradient(0,0,canvas.width,canvas.height);
      g.addColorStop(0,'#0f0c29');g.addColorStop(.5,'#302b63');g.addColorStop(1,'#24243e');
      ctx.fillStyle=g;ctx.fillRect(0,0,canvas.width,canvas.height);
      drawMatrix(arena,{x:0,y:0});drawMatrix(player.matrix,player.pos);
    }
    function loop(t=0){
      if(!running){ return; }
      if(paused){ requestAnimationFrame(loop); return; }
      const dt=t-lastTime; lastTime=t; dropCounter+=dt;
      if(dropCounter>dropInterval) drop();
      draw();
      requestAnimationFrame(loop);
    }

    function drawNext(){
      nctx.clearRect(0,0,nextCanvas.width,nextCanvas.height);
      const m = shapeFor(nextType);
      // center
      const offX = Math.floor((nextCanvas.width/SMALL - m[0].length)/2);
      const offY = Math.floor((nextCanvas.height/SMALL - m.length)/2);
      drawMatrix(m,{x:offX,y:offY},SMALL,nctx);
    }
    function drawHold(){
      hctx.clearRect(0,0,holdCanvas.width,holdCanvas.height);
      if(holdType==null) return;
      const m = shapeFor(holdType);
      const offX = Math.floor((holdCanvas.width/SMALL - m[0].length)/2);
      const offY = Math.floor((holdCanvas.height/SMALL - m.length)/2);
      drawMatrix(m,{x:offX,y:offY},SMALL,hctx);
    }

    function updateHUD(){ scoreEl.textContent=String(score); levelEl.textContent=String(level); }

    function gameOver(){
      running=false; SFX.gameOver(); vibrate([80,40,80]); screenShake(canvas, 300);
      // open initials overlay
      initialsOverlay.style.display='flex';
      setTimeout(()=>initialsInput.focus(), 0);
    }

    // Local scores
    function saveScoreLocal(initials,score){const key='tetrisScores';const arr=JSON.parse(localStorage.getItem(key)||'[]');arr.push({initials,score});arr.sort((a,b)=>b.score-a.score);if(arr.length>10)arr.length=10;localStorage.setItem(key,JSON.stringify(arr))}
    function getLocalScores(){return JSON.parse(localStorage.getItem('tetrisScores')||'[]')}
    function loadScores(){const list=getLocalScores();boardEl.innerHTML=list.map(s=>`<li>${(s.initials||'---').toUpperCase()}: ${s.score}</li>`).join('')}

    function submitInitialsAndReset(){
      const initials = (initialsInput.value || '---').toUpperCase().slice(0,3).replace(/[^A-Z]/g,'');
      saveScoreLocal(initials || '---', score);
      loadScores();
      initialsOverlay.style.display='none';
      startOverlay.style.display='flex';
      startBtn.textContent='Play Again';
    }

    function start(){
      arena=createMatrix(COLS,ROWS);
      player={pos:{x:0,y:0},matrix:null};
      dropCounter=0;lastTime=0;score=0;lines=0;level=0;canHold=true;holdType=null;nextType=randomType();
      updateHUD(); drawHold(); drawNext();
      running=true; paused=false; spawn(nextType); nextType=randomType(); drawNext();
      requestAnimationFrame(loop);
      setTimeout(()=>canvas.focus(), 50);
    }

    // Buttons
    startBtn.addEventListener('click',()=>{ensureAudio(); SFX.click(); startOverlay.style.display='none'; start()});
    restartBtn.addEventListener('click',()=>{SFX.click(); start()});
    pauseBtn.addEventListener('click',()=>{
      if(!running) return;
      paused = !paused;
      pauseBtn.textContent = paused ? 'Resume' : 'Pause';
      SFX.click();
    });
    submitInitials.addEventListener('click', submitInitialsAndReset);
    initialsInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ submitInitialsAndReset(); } });

    // Keyboard (prevent scroll)
    document.addEventListener('keydown',e=>{
      if(startOverlay.style.display!=='none' || initialsOverlay.style.display!=='none') return;
      if(['ArrowLeft','ArrowRight','ArrowDown','ArrowUp',' ','Enter','h','H','p','P'].includes(e.key)){e.preventDefault();}
      if(!running) return;
      if(e.key==='p' || e.key==='P'){ paused = !paused; pauseBtn.textContent = paused ? 'Resume' : 'Pause'; SFX.click(); return; }
      if(paused) return;
      if(e.key==='ArrowLeft')      move(-1);
      else if(e.key==='ArrowRight')move(1);
      else if(e.key==='ArrowDown') drop();
      else if(e.key==='ArrowUp')   spin();
      else if(e.key==='Enter' || e.key===' ') hardDrop();   // Enter or Space = hard drop
      else if(e.key==='h' || e.key==='H') hold();
    });

    // Init
    loadScores();
  })();
  </script>
</body>
</html>
